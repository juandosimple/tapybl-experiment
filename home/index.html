<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Tapybl MicroLearning</title>

    <!-- Bootstrap 5 + Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="../assets/css/style.css" rel="stylesheet" />
  </head>
  <body>
    <!-- Nav -->
    <nav class="navbar navbar-dark border-bottom border-dark sticky-top">
      <div class="container feed-wrapper">
        <a class="navbar-brand fw-bold" href="#">MicroTapybl</a>
        <div class="d-none d-md-block" style="max-width: 340px; width: 100%">
          <input
            class="form-control form-control-sm bg-dark-subtle border-0"
            placeholder="Search topics"
          />
        </div>
        <ul class="navbar-nav flex-row ms-auto gap-3">
          <li class="nav-item">
            <a class="nav-link" href="#"
              ><i class="bi bi-house-door fs-5"></i
            ></a>
          </li>
          <li class="nav-item">
            <a class="nav-link p-0" href="#"
              ><img
                src="https://i.pravatar.cc/28?img=5"
                class="rounded-circle"
                width="28"
                height="28"
                alt=""
            /></a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Feed -->
    <main class="container feed-wrapper my-4">
      <div class="row g-4">
        <div class="col-lg-8">
          <!-- Video card 1 -->
          <article class="vcard">
            <header class="d-flex align-items-center gap-2 p-3">
              <img
                src="../assets/img/course_one_logo.png"
                class="rounded-circle"
                width="40"
                height="40"
                alt=""
              />
              <div class="flex-grow-1">
                <div class="fw-semibold" style="color: #000">
                  NovaMind Institute
                </div>
                <small class="text-body-secondary">Cambridge, England</small>
              </div>
              <button class="btn btn-sm btn-link text-body-secondary">
                <i class="bi bi-three-dots"></i>
              </button>
            </header>

            <button
              class="vthumb-btn open-fs"
              data-src="../assets/video/video1.mp4"
              data-user="NovaMind Institute"
              data-caption="Did you know? – Science Fact Friday"
              data-avatar="../assets/img/course_one_logo.png"
              data-questions='[
                {"id":"q1a","time":4,"type":"single","text":"What is the chemical formula for water?","options":["H2O","O2","CO2","NaCl"],"correct":0},
                {"id":"q2a","time":9,"type":"poll","text":"Want more science shorts?","options":["Yes","Maybe later"]}
              ]'
            >
              <video class="vthumb" preload="metadata" muted playsinline loop>
                <source src="../assets/video/video1.mp4" type="video/mp4" />
              </video>
              <span class="play-badge"
                ><i class="bi bi-play-fill me-1"></i>Watch</span
              >
            </button>

            <div class="px-3 pt-2 pb-3">
              <div>Did you know? – Science Fact Friday</div>
              <div>
                <small class="text-body-secondary"
                  >2 hours ago • 1,024 likes</small
                >
              </div>
            </div>
          </article>

          <!-- Video card 2 -->
          <article class="vcard mt-4">
            <header class="d-flex align-items-center gap-2 p-3">
              <img
                src="../assets/img/course_two_logo.png"
                class="rounded-circle"
                width="40"
                height="40"
                alt=""
              />
              <div class="flex-grow-1">
                <div class="fw-semibold" style="color: #000">
                  Summit Mathematics Center
                </div>
                <small class="text-body-secondary">Buenos Aires, AR</small>
              </div>
              <button class="btn btn-sm btn-link text-body-secondary">
                <i class="bi bi-three-dots"></i>
              </button>
            </header>

            <button
              class="vthumb-btn open-fs"
              data-src="../assets/video/video2.mp4"
              data-user="Summit Mathematics Center"
              data-caption="Choose a math topic to dive into"
              data-avatar="../assets/img/course_two_logo.png"
              data-questions='[
                {
                  "id":"m2q1",
                  "time":2,
                  "type":"branch",
                  "text":"What are you interested in?",
                  "options":[
                    { "label":"Option A: Algebra",  "seek":5 },
                    { "label":"Option B: Geometry","seek":7 }
                  ]
                }
              ]'
            >
              <video class="vthumb" preload="metadata" muted playsinline loop>
                <source src="../assets/video/video2.mp4" type="video/mp4" />
              </video>
              <span class="play-badge"
                ><i class="bi bi-play-fill me-1"></i>Watch</span
              >
            </button>

            <div class="px-3 pt-2 pb-3">
              <div>
                <small class="text-body-secondary">Yesterday • 542 likes</small>
              </div>
            </div>
          </article>

          <!-- Video card 3 -->
          <article class="vcard mt-4">
            <header class="d-flex align-items-center gap-2 p-3">
              <img
                src="../assets/img/course_three_logo.png"
                class="rounded-circle"
                width="40"
                height="40"
                alt=""
              />
              <div class="flex-grow-1">
                <div class="fw-semibold" style="color: #000">
                  Aurora Physics Lab
                </div>
                <small class="text-body-secondary">Zurich, CH</small>
              </div>
              <button class="btn btn-sm btn-link text-body-secondary">
                <i class="bi bi-three-dots"></i>
              </button>
            </header>

            <button
              class="vthumb-btn open-fs"
              data-src="../assets/video/video3.mp4"
              data-user="Aurora Physics Lab"
              data-caption="Wave–particle duality in 30s"
              data-avatar="../assets/img/course_three_logo.png"
              data-questions='[
  {
    "id":"p3icons",
    "time":4,
    "type":"icons",
    "text":"Pick a deep‑dive:",
    "options":[
      { "label":"Energy",       "icon":"bi bi-lightning-charge", "seek":5  },
      { "label":"Double-slit",  "icon":"bi bi-collection-play",  "seek":15 },
      { "label":"Equations",    "icon":"bi bi-braces",           "seek":24 }
    ]
  }
]'
            >
              <video class="vthumb" preload="metadata" muted playsinline loop>
                <source src="../assets/video/video3.mp4" type="video/mp4" />
              </video>
              <span class="play-badge"
                ><i class="bi bi-play-fill me-1"></i>Watch</span
              >
            </button>

            <div class="px-3 pt-2 pb-3">
              <div>Wave–particle duality in 30s</div>
              <div>
                <small class="text-body-secondary">Today • 312 likes</small>
              </div>
            </div>
          </article>

          <!-- ... (rest of your cards unchanged) ... -->
        </div>

        <!-- Sidebar -->
        <aside class="col-lg-4 d-none d-lg-block">
          <div class="position-sticky" style="top: 88px">
            <div class="d-flex align-items-center">
              <img
                src="https://i.pravatar.cc/56?img=5"
                class="rounded-circle me-3"
                width="56"
                height="56"
                alt=""
              />
              <div class="flex-grow-1">
                <div class="fw-semibold">you</div>
                <small class="text-body-secondary">Your Name</small>
              </div>
            </div>

            <div class="mt-4 text-body-secondary small">© 2025 MicroTapybl</div>
          </div>
        </aside>
      </div>
    </main>

    <!-- Fake Fullscreen Overlay -->
    <section class="fshell" id="fshell" aria-hidden="true">
      <div class="fshell__video-wrap" id="fsWrap">
        <video id="fsVideo" playsinline></video>

        <!-- Double‑tap like heart -->
        <div class="dbl-like" id="dblLike">
          <i
            class="bi bi-heart-fill"
            style="font-size: 5rem; color: #ff2e63"
          ></i>
        </div>

        <!-- Top bar -->
        <div class="fshell__topbar">
          <button class="fshell__close" id="fsClose" aria-label="Close">
            <i class="bi bi-x-lg"></i>
          </button>
          <img
            id="fsAvatar"
            src=""
            class="rounded-circle"
            width="32"
            height="32"
            alt=""
          />
          <div id="fsUser" class="fw-semibold"></div>
          <div class="ms-auto d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-light" id="fsFollow">
              Follow
            </button>
            <button class="btn btn-sm btn-outline-light">
              <i class="bi bi-three-dots"></i>
            </button>
          </div>
        </div>

        <!-- Right actions -->
        <div class="fshell__actions text-center">
          <div>
            <button class="action" id="fsLike" aria-label="Like">
              <i class="bi bi-heart"></i>
            </button>
            <div class="count" id="likeCount">1.0k</div>
          </div>
          <div>
            <button class="action" id="fsShare" aria-label="Share">
              <i class="bi bi-send"></i>
            </button>
            <div class="count">Share</div>
          </div>
        </div>

        <!-- Bottom info -->
        <div class="fshell__bottom">
          <div class="caption">
            <div class="fw-semibold" id="fsUser2">user</div>
            <div id="fsCaption" class="text-body-secondary">Caption</div>
          </div>
          <div class="progress-ghost mt-2"><i id="fsProgress"></i></div>
        </div>

        <!-- Quiz Overlay -->
        <div class="quiz-shell" id="quizShell" hidden>
          <div class="quiz-card p-3">
            <div class="d-flex align-items-start gap-3">
              <div class="flex-grow-1">
                <div class="quiz-title mb-2" id="quizQuestion">
                  Question goes here
                </div>
                <div id="quizOptions" class="d-flex flex-wrap gap-2"></div>
                <div class="quiz-feedback small mt-2" id="quizFeedback"></div>
              </div>
            </div>
          </div>
        </div>
        <!-- /Quiz Overlay -->
      </div>
    </section>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      /* ===== Dynamic VH fix (mobile safe fullscreen) ===== */
      function setVhUnit() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty("--vh", vh + "px");
      }
      setVhUnit();
      window.addEventListener("resize", setVhUnit);
      window.addEventListener("orientationchange", setVhUnit);

      const fshell = document.getElementById("fshell");
      const fsVideo = document.getElementById("fsVideo");
      const fsClose = document.getElementById("fsClose");
      const fsUser = document.getElementById("fsUser");
      const fsUser2 = document.getElementById("fsUser2");
      const fsCaption = document.getElementById("fsCaption");
      const fsAvatar = document.getElementById("fsAvatar");
      const fsLikeBtn = document.getElementById("fsLike");
      const likeCountEl = document.getElementById("likeCount");
      const fsProgress = document.getElementById("fsProgress");
      const dblLike = document.getElementById("dblLike");

      // Quiz elements
      const quizShell = document.getElementById("quizShell");
      const quizQ = document.getElementById("quizQuestion");
      const quizOptions = document.getElementById("quizOptions");
      const quizFeedback = document.getElementById("quizFeedback");

      // Default questions if a video doesn't provide data-questions
      const DEFAULT_QUESTIONS = [
        {
          id: "q1",
          time: 3,
          type: "single",
          text: "What is the chemical formula for water?",
          options: ["H2O", "O2", "CO2", "NaCl"],
          correct: 0,
        },
        {
          id: "q2",
          time: 8,
          type: "poll",
          text: "Do you want more content like this?",
          options: ["Yes", "Not now"],
        },
      ];

      let lastTap = 0;
      let liked = false;
      let savedScrollY = 0;

      // Quiz state
      let currentQuestions = [];
      let askedSet = new Set();
      let nextIdx = 0;

      function parseQuestionsFrom(btn) {
        try {
          if (btn && btn.dataset.questions)
            return JSON.parse(btn.dataset.questions);
        } catch (e) {}
        return DEFAULT_QUESTIONS;
      }

      function resetQuizState() {
        askedSet.clear();
        nextIdx = 0;
        hideQuiz();
      }

      function showQuiz(q) {
        quizQ.textContent = q.text || "";
        quizOptions.innerHTML = "";

        // ==== Branching support: options can be strings OR objects {label, seek}
        (q.options || []).forEach((opt, i) => {
          const label =
            typeof opt === "object" && opt !== null
              ? opt.label || opt.text || `Option ${i + 1}`
              : String(opt);
          const b = document.createElement("button");
          b.className = "btn btn-sm btn-light";
          b.textContent = label;
          b.addEventListener("click", () => handleAnswer(q, i));
          quizOptions.appendChild(b);
        });

        // For branch we don't need feedback text initially
        quizFeedback.textContent = "";
        quizFeedback.className = "quiz-feedback small mt-2";

        quizShell.hidden = false;
        fsVideo.pause();
      }

      function hideQuiz() {
        quizShell.hidden = true;
      }

      function handleAnswer(q, chosenIdx) {
        askedSet.add(q.id);

        // ==== Branching: jump to time and resume
        if (q.type === "branch") {
          const opt = q.options?.[chosenIdx];
          hideQuiz();
          if (opt && typeof opt === "object" && Number.isFinite(opt.seek)) {
            fsVideo.currentTime = Math.max(0, opt.seek);
          }
          fsVideo.play().catch(() => {});
          return;
        }

        // Regular quiz/poll flow
        let resumeDelay = 800;
        if (q.type === "single" && Number.isInteger(q.correct)) {
          if (chosenIdx === q.correct) {
            quizFeedback.textContent = "Correct!";
            quizFeedback.classList.add("ok");
            quizFeedback.classList.remove("err");
          } else {
            quizFeedback.textContent = "Not quite!";
            quizFeedback.classList.add("err");
            quizFeedback.classList.remove("ok");
          }
        } else {
          quizFeedback.textContent = "Thanks for voting!";
          quizFeedback.classList.remove("err");
          quizFeedback.classList.add("ok");
        }

        setTimeout(() => {
          hideQuiz();
          fsVideo.play().catch(() => {});
        }, resumeDelay);
      }

      function checkQuizTick() {
        if (!currentQuestions.length || nextIdx >= currentQuestions.length)
          return;
        const q = currentQuestions[nextIdx];
        if (askedSet.has(q.id)) {
          nextIdx++;
          return;
        }
        if (fsVideo.currentTime >= (q.time || 0)) {
          showQuiz(q);
          nextIdx++;
        }
      }

      function openFS({
        src,
        user,
        caption,
        avatar,
        startAt = 0,
        btnEl = null,
      }) {
        // Lock scroll
        savedScrollY = window.scrollY;
        document.body.style.top = `-${savedScrollY}px`;
        document.body.style.position = "fixed";
        document.body.style.width = "100%";

        fshell.classList.add("active");
        fshell.setAttribute("aria-hidden", "false");

        // Populate UI
        fsUser.textContent = user;
        fsUser2.textContent = user;
        fsCaption.textContent = caption || "";
        fsAvatar.src = avatar || "";

        // Prepare video
        fsVideo.src = src;
        fsVideo.currentTime = startAt;
        fsVideo.muted = false;
        fsVideo.autoplay = true;
        fsVideo.playsInline = true;
        fsVideo.play().catch(() => {});

        // Reset likes
        liked = false;
        likeCountEl.textContent = "1.0k";
        fsLikeBtn.querySelector("i").className = "bi bi-heart";

        // Prepare questions for this video
        currentQuestions = parseQuestionsFrom(btnEl);
        currentQuestions.sort((a, b) => (a.time || 0) - (b.time || 0));
        resetQuizState();

        updateProgress();
      }

      function closeFS() {
        // Unlock scroll
        document.body.style.position = "";
        document.body.style.top = "";
        window.scrollTo(0, savedScrollY);

        fshell.classList.remove("active");
        fshell.setAttribute("aria-hidden", "true");
        fsVideo.pause();
        fsVideo.removeAttribute("src");
        fsVideo.load();

        // Reset quiz overlay
        resetQuizState();
      }

      // Open handlers
      document.querySelectorAll(".open-fs").forEach((btn) => {
        btn.addEventListener("click", () => {
          const src = btn.dataset.src;
          const user = btn.dataset.user;
          const caption = btn.dataset.caption;
          const avatar = btn.dataset.avatar;

          const thumbVideo = btn.querySelector("video");
          const startAt = thumbVideo ? thumbVideo.currentTime : 0;

          openFS({ src, user, caption, avatar, startAt, btnEl: btn });
        });
      });

      // Close actions
      fsClose.addEventListener("click", closeFS);
      fshell.addEventListener("click", (e) => {
        const wrap = document.getElementById("fsWrap");
        if (!wrap.contains(e.target) || e.target === fshell) closeFS();
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && fshell.classList.contains("active"))
          closeFS();
      });

      // Like toggle (button)
      fsLikeBtn.addEventListener("click", () => {
        liked = !liked;
        fsLikeBtn.querySelector("i").className = liked
          ? "bi bi-heart-fill"
          : "bi bi-heart";
        fsLikeBtn.style.background = liked
          ? "rgba(255,46,99,.6)"
          : "rgba(0,0,0,.45)";
        const n =
          parseInt((likeCountEl.textContent || "").replace(/\D/g, ""), 10) ||
          1000;
        likeCountEl.textContent = (
          liked ? n + 1 : Math.max(0, n - 1)
        ).toLocaleString();
      });

      // Double‑tap to like with heart pop
      fsVideo.addEventListener("click", () => {
        const now = Date.now();
        if (now - lastTap < 300) {
          liked = true;
          fsLikeBtn.querySelector("i").className = "bi bi-heart-fill";
          fsLikeBtn.style.background = "rgba(255,46,99,.6)";
          dblLike.classList.add("show");
          setTimeout(() => dblLike.classList.remove("show"), 400);
        }
        lastTap = now;
      });

      // Progress bar loop
      function updateProgress() {
        if (!fshell.classList.contains("active")) return;
        const pct = fsVideo.duration
          ? (fsVideo.currentTime / fsVideo.duration) * 100
          : 0;
        fsProgress.style.width = pct + "%";
        requestAnimationFrame(updateProgress);
      }
      fsVideo.addEventListener("loadedmetadata", updateProgress);
      fsVideo.addEventListener("timeupdate", updateProgress);
      fsVideo.addEventListener("timeupdate", checkQuizTick);
    </script>
  </body>
</html>
